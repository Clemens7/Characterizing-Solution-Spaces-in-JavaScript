
const GET_OBJECT_API_URL = "https://collectionapi.metmuseum.org/public/collection/v1/objects/{ID}";
const CACHE_KEY = "cache";

let cache = {};

export function initCache(){
    if(!localStorage.getItem(CACHE_KEY)){
        localStorage.setItem(CACHE_KEY, "{}");
    }
    cache = JSON.parse(localStorage.getItem(CACHE_KEY));
}


export async function getItem(id){
    let item = getItemFromLocalStorage(id);
    if(item)
    else{
        item = await getItemFromApi(id);
        if(item.message)
        saveItemToLocalStorage(item);
        return item;
        
    }}

export async function getItemFromApi(id){
    console.log("GOT ITEM FROM API");
    const response = await fetch(GET_OBJECT_API_URL.replace('{ID}', id));
    const rawData = await response.json();
    return rawData;
}

export function getItemFromLocalStorage(id){
    return cache[id];
}

export function saveItemToLocalStorage(item){
    cache[item.objectID] = item;
    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
}
import * as API from './api-abstraction.js'

const highlights= [39799, 459055, 437853, 435809, 436535, 360018, 634108, 459080, 435882, 271890, 459054, 436105]
const SEARCH_PARAM = "q";
const SEARCH_API_URL = "https://collectionapi.metmuseum.org/public/collection/v1/search?q={searchQuery}&hasImages=true";

const t0 = performance.now();

async function init(){

    API.initCache();
    let cart=JSON.parse(localStorage.getItem('cart'));
    if(cart) 
    var urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has(SEARCH_PARAM)){
        await search(urlParams.get(SEARCH_PARAM));
    }
}

async function search(searchQuery){
    var t1 = performance.now()
    console.log("Search... (" + (t1-t0) + " milliseconds).");
    let searchField = document.getElementById("search-info");
    searchField.innerText = `Searching for “${searchQuery}”...`;
    const response = await fetch(SEARCH_API_URL.replace('{searchQuery}', searchQuery));
    const rawData = await response.json();
    var t1 = performance.now()
    console.log("Got items... (" + (t1-t0) + " milliseconds).")
    let ids = rawData.objectIDs;
    if(!ids)
    let displayedItems = await getHighlights(ids);
    let artworks = "artworks";
    if(displayedItems == 1)
    searchField.innerText = `Found ${displayedItems} ${artworks} for “${searchQuery}”`;
}


async function getHighlights(highlightIds){
    let displayedItems = 0;
    for(let id of highlightIds){
        if(displayedItems >= 100){
            break;
        }
        let item = await API.getItem(id);   
        if(item.primaryImageSmall && displayedItems < 100){
            displayItem(item);
            console.log("displayed item");
            displayedItems++;
        }
    }
    
    var t1 = performance.now()
    console.log("Done... (" + (t1-t0) + " milliseconds).")
    return displayedItems;
}


function displayItem(item){
    let root = document.getElementById("gallery");
    let itemRoot = document.createElement("div");
    itemRoot.classList.add("thumb");
    itemRoot.innerHTML = renderItem(item, item.objectId);
    root.appendChild(itemRoot);
}

function renderItem(item, id){
    return `
    <a href="config.html?objectID=${item.objectID}" id="object-${item.objectID}">
      <img src="${item.primaryImageSmall}" alt="${item.title}" id="object-image-${item.objectID}">
      <div class="museum-label">
        <span class="artist">${item.artistDisplayName}</span>
        <span class="title">${item.title}</span>,
        <span class="date">${item.objectDate}</span>
      </div>
    </a>`;
}



init();